<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Defining your own Neural Net Module</title>
	
	<meta name="author" content="sohero">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/css/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<link rel="shortcut icon" href="favicon.ico">
    <!-- Update these with your own images
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS_HTML"></script>
    
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/sohero">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:herosgq@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
            <input type="text" class="st-default-search-input navbar-toggle" style="width:100px;">
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/images/bl.png" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	Qiang Brother Notes.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/sohero">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:herosgq@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
        <li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<div style="width:171px;margin-left:auto;margin-right:auto;">
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','ajvL7F6K122b67uo9oa2','2.0.0');
</script>
<input type="text" class="st-default-search-input" style="width:130px;">
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Defining your own Neural Net Module </h1>
</div>
	
<article>

	<div class="col-sm-12">
	 <span class="post-date">
	 	2015-08-18 
	 </span>
	  <div class="article_body">
	  <p>Modules are bricks to build neural networks. A <strong>Module</strong> is a neural network by itself, but it can be combined with other networks using container classes to create complex neural networks. <strong>Module</strong> is an abstract class which defines fundamental methods necessary for a training a neural network. All modules are serializable.</p>
<p>Modules contain two states variables: <em>output</em> and <em>gradInput</em>. Here we review the set of basic functions that a Module has to implement:</p>
<p><strong>[output] forward(input)</strong> Takes an input object, and computes the corresponding output of the module. In general input and output are Tensors. However, some special sub-classes like table layers might expect something else.</p>
<p>After a forward(), the output state variable should have been updated to the new value.</p>
<p>It is not advised to override this function. Instead, one should implement <strong>updateOutput(input)</strong> function. The forward module in the abstract parent class Module will call <strong>updateOutput(input).</strong></p>
<p><strong>[gradInput] backward(input, gradOutput)</strong> Performs a backpropagation step through the module, with respect to the given input. In general this method makes the assumption <strong>forward(input)</strong> has been called before, with the same input. This is necessary for optimization reasons. If you do not respect this rule, backward() will compute incorrect gradients.</p>
<p>A backpropagation step consist in computing two kind of gradients at input given gradOutput (gradients with respect to the output of the module). This function simply performs this task using two function calls:</p>
<ul>
<li>A function call to <strong>updateGradInput(input, gradOutput)</strong>.</li>
<li>A function call to <strong>accGradParameters(input,gradOutput)</strong>.</li>
</ul>
<p>It is not advised to override this function call in custom classes. It is better to override <strong>updateGradInput(input, gradOutput)</strong> and <strong>accGradParameters(input, gradOutput)</strong> functions.</p>
<p><strong>[output] updateOutput(input, gradOutput)</strong> When defining a new module, this method should be overloaded.</p>
<p>Computes the output using the current parameter set of the class and input. This function returns the result which is stored in the output field.</p>
<p><strong>[gradInput] updateGradInput(input, gradOutput)</strong> When defining a new module, this method should be overloaded.</p>
<p>Computing the gradient of the module with respect to its own input. This is returned in gradInput. Also, the gradInput state variable is updated accordingly.</p>
<p><strong>[gradInput] accGradParameters(input, gradOutput)</strong> When defining a new module, this method may need to be overloaded, if the module has trainable parameters.</p>
<p>Computing the gradient of the module with respect to its own parameters. Many modules do not perform this step as they do not have any parameters. The state variable name for the parameters is module dependent. The module is expected to accumulate the gradients with respect to the parameters in some variable.</p>
<p>Zeroing this accumulation is achieved with <strong>zeroGradParameters()</strong> and updating the parameters according to this accumulation is done with <strong>updateParameters()</strong>.</p>
<p><strong>reset()</strong> This method defines how the trainable parameters are reset, i.e.Â initialized before training.</p>
<hr />
<p>Modules provide a few other methods that you might want to define, if you are not planing to use the <strong>optim</strong> package. These methods help <strong>zero()</strong> the parameters, and update them using very basic techniques.</p>
<p>In terms of code structure, <em>Torch</em> provides a class model, which we use for inheritance, and in general for the definition of all the modules in <em>nn</em>. Here is an empty holder for a typical new class:</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="kw">local</span> NewClass<span class="ot">,</span> Parent <span class="ot">=</span> torch<span class="ot">.</span>class<span class="ot">(</span><span class="st">&#39;nn.NewClass&#39;</span><span class="ot">,</span> <span class="st">&#39;nn.Module&#39;</span><span class="ot">)</span>
 
<span class="kw">function</span> NewClass:__init<span class="ot">()</span>
   parent<span class="ot">.</span>__init<span class="ot">(</span>self<span class="ot">)</span>
<span class="kw">end</span>
 
<span class="kw">function</span> NewClass:updateOutput<span class="ot">(</span>input<span class="ot">)</span>
<span class="kw">end</span>
 
<span class="kw">function</span> NewClass:updateGradInput<span class="ot">(</span>input<span class="ot">,</span> gradOutput<span class="ot">)</span>
<span class="kw">end</span>
 
<span class="kw">function</span> NewClass:accGradParameters<span class="ot">(</span>input<span class="ot">,</span> gradOutput<span class="ot">)</span>
<span class="kw">end</span>
 
<span class="kw">function</span> NewClass:reset<span class="ot">()</span>
<span class="kw">end</span></code></pre></div>
<p>When defining a new class, all we need to do is fill in these empty functions. Note that when defining the constructor *__init()*, we always call the parentâs constructor first.</p>
<h3 id="dropout-activation-units">Dropout Activation Units</h3>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="kw">local</span> Dropout<span class="ot">,</span> Parent <span class="ot">=</span> torch<span class="ot">.</span>class<span class="ot">(</span><span class="st">&#39;nn.Dropout&#39;</span><span class="ot">,</span> <span class="st">&#39;nn.Module&#39;</span><span class="ot">)</span>
 
<span class="kw">function</span> Dropout:__init<span class="ot">(</span>percentage<span class="ot">)</span>
   Parent<span class="ot">.</span>__init<span class="ot">(</span>self<span class="ot">)</span>
   self<span class="ot">.</span>p <span class="ot">=</span> percentage <span class="kw">or</span> <span class="dv">0.5</span>
   <span class="kw">if</span> self<span class="ot">.</span>p <span class="ot">&gt;</span> <span class="dv">1</span> <span class="kw">or</span> self<span class="ot">.</span>p <span class="ot">&lt;</span> <span class="dv">0</span> <span class="kw">then</span>
      <span class="fu">error</span><span class="ot">(</span><span class="st">&#39;&lt;Dropout&gt; illegal percentage, must be 0 &lt;= p &lt;= 1&#39;</span><span class="ot">)</span>
   <span class="kw">end</span>
<span class="kw">end</span>
 
<span class="kw">function</span> Dropout:updateOutput<span class="ot">(</span>input<span class="ot">)</span>
   self<span class="ot">.</span>noise <span class="ot">=</span> torch<span class="ot">.</span>rand<span class="ot">(</span>input:size<span class="ot">())</span> <span class="co">-- uniform noise between 0 and 1</span>
   self<span class="ot">.</span>noise:add<span class="ot">(</span><span class="dv">1</span> <span class="ot">-</span> self<span class="ot">.</span>p<span class="ot">)</span>:<span class="fu">floor</span><span class="ot">()</span>  <span class="co">-- a percentage of noise</span>
   self<span class="ot">.</span>output:resizeAs<span class="ot">(</span>input<span class="ot">)</span>:copy<span class="ot">(</span>input<span class="ot">)</span>
   self<span class="ot">.</span>output:cmul<span class="ot">(</span>self<span class="ot">.</span>noise<span class="ot">)</span>
   <span class="kw">return</span> self<span class="ot">.</span>output
<span class="kw">end</span>
 
<span class="kw">function</span> Dropout:updateGradInput<span class="ot">(</span>input<span class="ot">,</span> gradOutput<span class="ot">)</span>
   self<span class="ot">.</span>gradInput:resizeAs<span class="ot">(</span>gradOutput<span class="ot">)</span>:copy<span class="ot">(</span>gradOutput<span class="ot">)</span>
   self<span class="ot">.</span>gradInput:cmul<span class="ot">(</span>self<span class="ot">.</span>noise<span class="ot">)</span> <span class="co">-- simply mask the gradients with the noise vector</span>
   <span class="kw">return</span> self<span class="ot">.</span>gradInput
<span class="kw">end</span></code></pre></div>
<p>The file is provided in this directory, in <em>Dropout.lua</em>. The script <em>1_dropout.lua</em> demonstrates how to create an instance of this module, and test it on some data (lena):</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="co">-- in this file, we test the dropout module we&#39;ve defined:</span>
<span class="fu">require</span> <span class="st">&#39;nn&#39;</span>
<span class="fu">require</span> <span class="st">&#39;Dropout&#39;</span>
<span class="fu">require</span> <span class="st">&#39;image&#39;</span>
 
<span class="co">-- define a dropout object:</span>
n <span class="ot">=</span> nn<span class="ot">.</span>Dropout<span class="ot">(</span><span class="dv">0.5</span><span class="ot">)</span>
 
<span class="co">-- load an image:</span>
i <span class="ot">=</span> image<span class="ot">.</span>lena<span class="ot">()</span>
 
<span class="co">-- process the image:</span>
result <span class="ot">=</span> n:forward<span class="ot">(</span>i<span class="ot">)</span>
 
<span class="co">-- display results:</span>
image<span class="ot">.</span>display<span class="ot">{</span>image<span class="ot">=</span>i<span class="ot">,</span> legend<span class="ot">=</span><span class="st">&#39;original image&#39;</span><span class="ot">}</span>
image<span class="ot">.</span>display<span class="ot">{</span>image<span class="ot">=</span>result<span class="ot">,</span> legend<span class="ot">=</span><span class="st">&#39;dropout-processed image&#39;</span><span class="ot">}</span>
 
<span class="co">-- some stats:</span>
mse <span class="ot">=</span> i:dist<span class="ot">(</span>result<span class="ot">)</span>
<span class="fu">print</span><span class="ot">(</span><span class="st">&#39;mse between original imgae and dropout-processed image: &#39;</span> <span class="ot">..</span> mse<span class="ot">)</span></code></pre></div>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#lua-ref">
					lua <span>(10)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#lua-ref">
					lua <span>(10)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-12">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Defining your own Neural Net Module"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/foundation/lua/2015/08/17/the-requ-unit.html" title="The ReQU unit">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/lua/2015/08/19/torch7-serialization.html" title="Torch7 Serialization">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




		<footer>
			<hr/>
			<p>
				&copy; 2016 <a href="http://guoqiang.gq">sohero</a>.
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258527085'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1258527085%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
			</p>
		</footer>
	</div>

	<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
	<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>




<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Defining your own Neural Net Module | An old brother's memo.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">An old brother's memo.</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Defining your own Neural Net Module</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-07-14</div><div class="post-categories"><a class="post-category-link" href="/categories/machine-learning/">machine learning</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/lua/">lua</a>/<a class="post-tag-link" href="/tags/torch/">torch</a></div></div></div><article><div class="container post"><p>Modules are bricks to build neural networks. A <strong>Module</strong> is a neural network by itself, but it can be combined with other networks using container classes to create complex neural networks. <strong>Module</strong> is an abstract class which defines fundamental methods necessary for a training a neural network. All modules are serializable.</p>
<p>Modules contain two states variables: <em>output</em> and <em>gradInput</em>. Here we review the set of basic functions that a Module has to implement:</p>
<p><strong>[output] forward(input)</strong> Takes an input object, and computes the corresponding output of the module. In general input and output are Tensors. However, some special sub-classes like table layers might expect something else.</p>
<p>After a forward(), the output state variable should have been updated to the new value.</p>
<p>It is not advised to override this function. Instead, one should implement <strong>updateOutput(input)</strong> function. The forward module in the abstract parent class Module will call <strong>updateOutput(input).</strong></p>
<p><strong>[gradInput] backward(input, gradOutput)</strong> Performs a backpropagation step through the module, with respect to the given input. In general this method makes the assumption <strong>forward(input)</strong> has been called before, with the same input. This is necessary for optimization reasons. If you do not respect this rule, backward() will compute incorrect gradients.</p>
<p>A backpropagation step consist in computing two kind of gradients at input given gradOutput (gradients with respect to the output of the module). This function simply performs this task using two function calls:</p>
<ul>
<li>A function call to <strong>updateGradInput(input, gradOutput)</strong>.</li>
<li>A function call to <strong>accGradParameters(input,gradOutput)</strong>.</li>
</ul>
<p>It is not advised to override this function call in custom classes. It is better to override <strong>updateGradInput(input, gradOutput)</strong> and <strong>accGradParameters(input, gradOutput)</strong> functions.</p>
<p><strong>[output] updateOutput(input, gradOutput)</strong> When defining a new module, this method should be overloaded.</p>
<p>Computes the output using the current parameter set of the class and input. This function returns the result which is stored in the output field.</p>
<p><strong>[gradInput] updateGradInput(input, gradOutput)</strong> When defining a new module, this method should be overloaded.</p>
<p>Computing the gradient of the module with respect to its own input. This is returned in gradInput. Also, the gradInput state variable is updated accordingly.</p>
<p><strong>[gradInput] accGradParameters(input, gradOutput)</strong> When defining a new module, this method may need to be overloaded, if the module has trainable parameters.</p>
<p>Computing the gradient of the module with respect to its own parameters. Many modules do not perform this step as they do not have any parameters. The state variable name for the parameters is module dependent. The module is expected to accumulate the gradients with respect to the parameters in some variable.</p>
<p>Zeroing this accumulation is achieved with <strong>zeroGradParameters()</strong> and updating the parameters according to this accumulation is done with <strong>updateParameters()</strong>.</p>
<p><strong>reset()</strong> This method defines how the trainable parameters are reset, i.e. initialized before training.</p>
<hr>
<p>Modules provide a few other methods that you might want to define, if you are not planing to use the <strong>optim</strong> package. These methods help <strong>zero()</strong> the parameters, and update them using very basic techniques.</p>
<p>In terms of code structure, <em>Torch</em> provides a class model, which we use for inheritance, and in general for the definition of all the modules in <em>nn</em>. Here is an empty holder for a typical new class: <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> NewClass, Parent = torch.class(<span class="string">'nn.NewClass'</span>, <span class="string">'nn.Module'</span>)</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewClass:__init</span><span class="params">()</span></span></div><div class="line">   parent.__init(self)</div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewClass:updateOutput</span><span class="params">(input)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewClass:updateGradInput</span><span class="params">(input, gradOutput)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewClass:accGradParameters</span><span class="params">(input, gradOutput)</span></span></div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewClass:reset</span><span class="params">()</span></span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>When defining a new class, all we need to do is fill in these empty functions. Note that when defining the constructor *__init()*, we always call the parent’s constructor first.</p>
<h3 id="dropout-activation-units">Dropout Activation Units</h3>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> Dropout, Parent = torch.class(<span class="string">'nn.Dropout'</span>, <span class="string">'nn.Module'</span>)</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dropout:__init</span><span class="params">(percentage)</span></span></div><div class="line">   Parent.__init(self)</div><div class="line">   self.p = percentage <span class="keyword">or</span> <span class="number">0.5</span></div><div class="line">   <span class="keyword">if</span> self.p &gt; <span class="number">1</span> <span class="keyword">or</span> self.p &lt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">      <span class="built_in">error</span>(<span class="string">'&lt;Dropout&gt; illegal percentage, must be 0 &lt;= p &lt;= 1'</span>)</div><div class="line">   <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dropout:updateOutput</span><span class="params">(input)</span></span></div><div class="line">   self.noise = torch.rand(input:size()) <span class="comment">-- uniform noise between 0 and 1</span></div><div class="line">   self.noise:add(<span class="number">1</span> - self.p):floor()  <span class="comment">-- a percentage of noise</span></div><div class="line">   self.output:resizeAs(input):copy(input)</div><div class="line">   self.output:cmul(self.noise)</div><div class="line">   <span class="keyword">return</span> self.output</div><div class="line"><span class="keyword">end</span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dropout:updateGradInput</span><span class="params">(input, gradOutput)</span></span></div><div class="line">   self.gradInput:resizeAs(gradOutput):copy(gradOutput)</div><div class="line">   self.gradInput:cmul(self.noise) <span class="comment">-- simply mask the gradients with the noise vector</span></div><div class="line">   <span class="keyword">return</span> self.gradInput</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>The file is provided in this directory, in <em>Dropout.lua</em>. The script <em>1_dropout.lua</em> demonstrates how to create an instance of this module, and test it on some data (lena): <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- in this file, we test the dropout module we've defined:</span></div><div class="line"><span class="built_in">require</span> <span class="string">'nn'</span></div><div class="line"><span class="built_in">require</span> <span class="string">'Dropout'</span></div><div class="line"><span class="built_in">require</span> <span class="string">'image'</span></div><div class="line"> </div><div class="line"><span class="comment">-- define a dropout object:</span></div><div class="line">n = nn.Dropout(<span class="number">0.5</span>)</div><div class="line"> </div><div class="line"><span class="comment">-- load an image:</span></div><div class="line">i = image.lena()</div><div class="line"> </div><div class="line"><span class="comment">-- process the image:</span></div><div class="line">result = n:forward(i)</div><div class="line"> </div><div class="line"><span class="comment">-- display results:</span></div><div class="line">image.display&#123;image=i, legend=<span class="string">'original image'</span>&#125;</div><div class="line">image.display&#123;image=result, legend=<span class="string">'dropout-processed image'</span>&#125;</div><div class="line"> </div><div class="line"><span class="comment">-- some stats:</span></div><div class="line">mse = i:dist(result)</div><div class="line"><span class="built_in">print</span>(<span class="string">'mse between original imgae and dropout-processed image: '</span> .. mse)</div></pre></td></tr></table></figure></p>
</div><!-- comment system--><div class="container"><hr><div data-thread-key="2016/07/14/Defining your own Neural Net Module/" data-title="Defining your own Neural Net Module" data-url="https://www.sgq.mobi/2016/07/14/Defining your own Neural Net Module/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'sgqmobi'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:dad@sdz.red" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/sohero" target="_blank"><i class="fa fa-github"></i></a><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1261298720'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1261298720%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
</script></div><div class="footer">© 2017 <a href="/" rel="nofollow">Hero Memo</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><script>MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>
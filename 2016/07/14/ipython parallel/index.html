<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ipython parallel | An old brother's memo.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">An old brother's memo.</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>ipython parallel</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-07-14</div><div class="post-categories"><a class="post-category-link" href="/categories/tools/">tools</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ipython/">ipython</a>/<a class="post-tag-link" href="/tags/python/">python</a></div></div></div><article><div class="container post"><p>IPython 3.x. Best using in the ipython environment, or in a py file may raising unpredictable error.</p>
<h2 id="Architecture-overview"><a href="#Architecture-overview" class="headerlink" title="Architecture overview"></a>Architecture overview</h2><p><img src="/images/28.png" alt=""></p>
<p>The IPython architecture consists of four components:</p>
<ul>
<li>The IPython engine.</li>
<li>The IPython hub.</li>
<li>The IPython schedulers.</li>
<li>The controller client.</li>
</ul>
<p>These components live in the <code>IPython.parallel</code> package and are installed with IPython.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>To use IPython for parallel computing, you need to start one instance of the controller and one or more instances of the engine. Initially, it is best to simply start a controller and engines on a single host using the <code>ipcluster</code> command. To start a controller and 4 engines on your localhost, just do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipcluster start -n 4</div></pre></td></tr></table></figure>
<p>Once you have started the IPython controller and one or more engines, you are ready to use the engines to do something useful. To make sure everything is working correctly, try the following commands:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> IPython.parallel <span class="keyword">import</span> Client</div><div class="line"> </div><div class="line">In [<span class="number">2</span>]: c = Client()</div><div class="line"> </div><div class="line">In [<span class="number">4</span>]: c.ids</div><div class="line">Out[<span class="number">4</span>]: set([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line"> </div><div class="line">In [<span class="number">5</span>]: c[:].apply_sync(<span class="keyword">lambda</span> : <span class="string">"Hello, World"</span>)</div><div class="line">Out[<span class="number">5</span>]: [ <span class="string">'Hello, World'</span>, <span class="string">'Hello, World'</span>, <span class="string">'Hello, World'</span>, <span class="string">'Hello, World'</span> ]</div></pre></td></tr></table></figure>
<h2 id="IPython-client-and-views"><a href="#IPython-client-and-views" class="headerlink" title="IPython client and views"></a>IPython client and views</h2><p>There is one primary object, the <code>Client</code>, for connecting to a cluster. For each execution model, there is a corresponding <code>View</code>. These views allow users to interact with a set of engines through the interface. Here are the two default views:</p>
<ul>
<li>The <code>DirectView</code> class for explicit addressing.</li>
<li>The <code>LoadBalancedView</code> class for destination-agnostic scheduling.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> IPython.parallel <span class="keyword">import</span> Client</div><div class="line">In [<span class="number">2</span>]: rc = Client()</div><div class="line"> </div><div class="line"><span class="comment"># for a visible LAN controller listening on an external port:</span></div><div class="line">In [<span class="number">2</span>]: rc = Client(<span class="string">'tcp://192.168.1.16:10101'</span>)</div><div class="line"><span class="comment"># or to connect with a specific profile you have set up:</span></div><div class="line">In [<span class="number">3</span>]: rc = Client(profile=<span class="string">'mpi'</span>)</div></pre></td></tr></table></figure>
<h2 id="DirectView"><a href="#DirectView" class="headerlink" title="DirectView"></a>DirectView</h2><p>For direct execution, we will make use of a <code>DirectView</code> object, which can be constructed via list-access to the client:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">4</span>]: dview = rc[:] <span class="comment"># use all engines</span></div></pre></td></tr></table></figure>
<h3 id="Parallel-map"><a href="#Parallel-map" class="headerlink" title="Parallel map"></a>Parallel map</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">62</span>]: serial_result = map(<span class="keyword">lambda</span> x:x**<span class="number">10</span>, range(<span class="number">32</span>))</div><div class="line"> </div><div class="line">In [<span class="number">63</span>]: parallel_result = dview.map_sync(<span class="keyword">lambda</span> x: x**<span class="number">10</span>, range(<span class="number">32</span>))</div><div class="line"> </div><div class="line">In [<span class="number">67</span>]: serial_result==parallel_result</div><div class="line">Out[<span class="number">67</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure>
<h3 id="Remote-function-decorators"><a href="#Remote-function-decorators" class="headerlink" title="Remote function decorators"></a>Remote function decorators</h3><p>Remote functions are just like normal functions, but when they are called, they execute on one or more engines, rather than locally. IPython provides two decorators:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">10</span>]: @dview.remote(block=<span class="keyword">True</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">getpid</span><span class="params">()</span>:</span></div><div class="line">   ....:     <span class="keyword">import</span> os</div><div class="line">   ....:     <span class="keyword">return</span> os.getpid()</div><div class="line">   ....:</div><div class="line"> </div><div class="line">In [<span class="number">11</span>]: getpid()</div><div class="line">Out[<span class="number">11</span>]: [<span class="number">12345</span>, <span class="number">12346</span>, <span class="number">12347</span>, <span class="number">12348</span>]</div></pre></td></tr></table></figure></p>
<p>The <code>@parallel</code> decorator creates parallel functions, that break up an element-wise operations and distribute them, reconstructing the result.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">12</span>]: <span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"> </div><div class="line">In [<span class="number">13</span>]: A = np.random.random((<span class="number">64</span>,<span class="number">48</span>))</div><div class="line"> </div><div class="line">In [<span class="number">14</span>]: @dview.parallel(block=<span class="keyword">True</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">pmul</span><span class="params">(A,B)</span>:</span></div><div class="line">   ....:     <span class="keyword">return</span> A*B</div><div class="line"> </div><div class="line">In [<span class="number">15</span>]: C_local = A*A</div><div class="line"> </div><div class="line">In [<span class="number">16</span>]: C_remote = pmul(A,A)</div><div class="line"> </div><div class="line">In [<span class="number">17</span>]: (C_local == C_remote).all()</div><div class="line">Out[<span class="number">17</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>A quick example to illustrate the difference in arguments for the two modes:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">16</span>]: @dview.parallel(block=<span class="keyword">True</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(x)</span>:</span></div><div class="line">   ....:     <span class="keyword">return</span> str(x)</div><div class="line">   ....:</div><div class="line"> </div><div class="line">In [<span class="number">17</span>]: echo(range(<span class="number">5</span>))</div><div class="line">Out[<span class="number">17</span>]: [<span class="string">'[0, 1]'</span>, <span class="string">'[2]'</span>, <span class="string">'[3]'</span>, <span class="string">'[4]'</span>]</div><div class="line"> </div><div class="line">In [<span class="number">18</span>]: echo.map(range(<span class="number">5</span>))</div><div class="line">Out[<span class="number">18</span>]: [<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>]</div></pre></td></tr></table></figure></p>
<h3 id="Calling-Python-functions"><a href="#Calling-Python-functions" class="headerlink" title="Calling Python functions"></a><a href="http://ipython.org/ipython-doc/3/parallel/parallel_multiengine.html#calling-python-functions" target="_blank" rel="external">Calling Python functions</a></h3><p>The most basic type of operation that can be performed on the engines is to execute Python code or call Python functions. Executing Python code can be done in blocking or non-blocking mode (non-blocking is default) using the <code>View.execute()</code> method, and calling functions can be done via the <code>View.apply()</code> method.</p>
<h3 id="Moving-Python-objects-around"><a href="#Moving-Python-objects-around" class="headerlink" title="Moving Python objects around"></a><a href="http://ipython.org/ipython-doc/3/parallel/parallel_multiengine.html#moving-python-objects-around" target="_blank" rel="external">Moving Python objects around</a></h3><h3 id="Other-things-to-look-at"><a href="#Other-things-to-look-at" class="headerlink" title="Other things to look at"></a><a href="http://ipython.org/ipython-doc/3/parallel/parallel_multiengine.html#other-things-to-look-at" target="_blank" rel="external">Other things to look at</a></h3><h4 id="How-to-do-parallel-list-comprehensions"><a href="#How-to-do-parallel-list-comprehensions" class="headerlink" title="How to do parallel list comprehensions"></a>How to do parallel list comprehensions</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">66</span>]: dview.scatter(<span class="string">'x'</span>,range(<span class="number">64</span>))</div><div class="line"> </div><div class="line">In [<span class="number">67</span>]: %px y = [i**<span class="number">10</span> <span class="keyword">for</span> i <span class="keyword">in</span> x]</div><div class="line">Parallel execution on engines: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"> </div><div class="line">In [<span class="number">68</span>]: y = dview.gather(<span class="string">'y'</span>)</div><div class="line"> </div><div class="line">In [<span class="number">69</span>]: <span class="keyword">print</span> y</div><div class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">1024</span>, <span class="number">59049</span>, <span class="number">1048576</span>, <span class="number">9765625</span>, <span class="number">60466176</span>, <span class="number">282475249</span>, <span class="number">1073741824</span>,...]</div></pre></td></tr></table></figure>
<h4 id="Remote-imports"><a href="#Remote-imports" class="headerlink" title="Remote imports"></a>Remote imports</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">69</span>]: <span class="keyword">with</span> dview.sync_imports():</div><div class="line">   ....:     <span class="keyword">import</span> numpy</div><div class="line">importing numpy on engine(s)</div></pre></td></tr></table></figure>
<blockquote>
<p>sync_imports() does not allow import foo as bar syntax, because the assignment represented by the as bar part is not available to the import hook.</p>
</blockquote>
<h4 id="Parallel-exceptions"><a href="#Parallel-exceptions" class="headerlink" title="Parallel exceptions"></a><a href="http://ipython.org/ipython-doc/3/parallel/parallel_multiengine.html#parallel-exceptions" target="_blank" rel="external">Parallel exceptions</a></h4><h2 id="LoadBalancedView"><a href="#LoadBalancedView" class="headerlink" title="LoadBalancedView"></a>LoadBalancedView</h2><p>For load-balanced execution, we will make use of a <code>LoadBalancedView</code> object, which can be constructed via the client’s <code>load_balanced_view()</code> method:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">4</span>]: lview = rc.load_balanced_view() <span class="comment"># default load-balanced view</span></div></pre></td></tr></table></figure>
<h3 id="Parallel-map-1"><a href="#Parallel-map-1" class="headerlink" title="Parallel map"></a>Parallel map</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">62</span>]: lview.block = <span class="keyword">True</span></div><div class="line"> </div><div class="line">In [<span class="number">63</span>]: serial_result = map(<span class="keyword">lambda</span> x:x**<span class="number">10</span>, range(<span class="number">32</span>))</div><div class="line"> </div><div class="line">In [<span class="number">64</span>]: parallel_result = lview.map(<span class="keyword">lambda</span> x:x**<span class="number">10</span>, range(<span class="number">32</span>))</div><div class="line"> </div><div class="line">In [<span class="number">65</span>]: serial_result==parallel_result</div><div class="line">Out[<span class="number">65</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure>
<h3 id="Parallel-function-decorator"><a href="#Parallel-function-decorator" class="headerlink" title="Parallel function decorator"></a>Parallel function decorator</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">10</span>]: @lview.parallel()</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></div><div class="line">   ....:     <span class="keyword">return</span> <span class="number">10.0</span>*x**<span class="number">4</span></div><div class="line">   ....:</div><div class="line"> </div><div class="line">In [<span class="number">11</span>]: f.map(range(<span class="number">32</span>))    <span class="comment"># this is done in parallel</span></div><div class="line">Out[<span class="number">11</span>]: [<span class="number">0.0</span>,<span class="number">10.0</span>,<span class="number">160.0</span>,...]</div></pre></td></tr></table></figure>
<h3 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h3><h4 id="Functional-Dependencies"><a href="#Functional-Dependencies" class="headerlink" title="Functional Dependencies"></a>Functional Dependencies</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">9</span>]: <span class="keyword">from</span> IPython.parallel <span class="keyword">import</span> depend, require, dependent</div><div class="line">In [<span class="number">10</span>]: @require(<span class="string">'numpy'</span>, <span class="string">'zmq'</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">myfunc</span><span class="params">()</span>:</span></div><div class="line">   ....:     <span class="keyword">return</span> dostuff()</div><div class="line"> </div><div class="line">In [<span class="number">10</span>]: <span class="function"><span class="keyword">def</span> <span class="title">platform_specific</span><span class="params">(plat)</span>:</span></div><div class="line">   ....:    <span class="keyword">import</span> sys</div><div class="line">   ....:    <span class="keyword">return</span> sys.platform == plat</div><div class="line"> </div><div class="line">In [<span class="number">11</span>]: @depend(platform_specific, <span class="string">'darwin'</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">mactask</span><span class="params">()</span>:</span></div><div class="line">   ....:    do_mac_stuff()</div><div class="line"> </div><div class="line">In [<span class="number">12</span>]: @depend(platform_specific, <span class="string">'nt'</span>)</div><div class="line">   ....: <span class="function"><span class="keyword">def</span> <span class="title">wintask</span><span class="params">()</span>:</span></div><div class="line">   ....:    do_windows_stuff()</div></pre></td></tr></table></figure>
<h4 id="Graph-Dependencies"><a href="#Graph-Dependencies" class="headerlink" title="Graph Dependencies"></a>Graph Dependencies</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">14</span>]: client.block=<span class="keyword">False</span></div><div class="line"> </div><div class="line">In [<span class="number">15</span>]: ar = lview.apply(f, args, kwargs)</div><div class="line"> </div><div class="line">In [<span class="number">16</span>]: ar2 = lview.apply(f2)</div><div class="line"> </div><div class="line">In [<span class="number">17</span>]: <span class="keyword">with</span> lview.temp_flags(after=[ar,ar2]):</div><div class="line">   ....:    ar3 = lview.apply(f3)</div><div class="line"> </div><div class="line">In [<span class="number">18</span>]: <span class="keyword">with</span> lview.temp_flags(follow=[ar], timeout=<span class="number">2.5</span>)</div><div class="line">   ....:    ar4 = lview.apply(f3)</div></pre></td></tr></table></figure></div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:dad@sdz.red" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/sohero" target="_blank"><i class="fa fa-github"></i></a><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1261298720'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1261298720%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
</script></div><div class="footer">© 2017 <a href="/" rel="nofollow">Hero Memo</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><script>MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>
<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>keras | An old brother's memo.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">An old brother's memo.</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>keras</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-09-22</div><div class="post-categories"><a class="post-category-link" href="/categories/coding/">coding</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/deep-learning/">deep learning</a>/<a class="post-tag-link" href="/tags/python/">python</a></div></div></div><article><div class="container post"><h2 id="useful-function">Useful Function</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 洗牌，搞乱训练集的顺序</span></div><div class="line">numpy.random.shuffle(x)</div><div class="line"><span class="comment"># 对训练集X进行正则化</span></div><div class="line">scaler = sklearn.preprocessing.StandardScaler()</div><div class="line">scaler.fit(x)</div><div class="line">X = scaler.transform(x)</div><div class="line"><span class="comment"># 对Y进行编码</span></div><div class="line">encoder = sklearn.preprocessing.LabelEncoder()</div><div class="line">encoder.fit(labels)</div><div class="line">y = encoder.transform(labels).astype(np.int32)</div><div class="line">y = keras.utils.np_utils.to_categorical(y)</div><div class="line"><span class="comment">#  as it's name</span></div><div class="line">sklearn.cross_validation.train_test_split(...)</div></pre></td></tr></table></figure>
<h2 id="getting-started">Getting started</h2>
<p>The core data structure of Keras is a <strong>model</strong>, a way to organize layers. The main type of model is the <code>Sequential</code> model, a linear stack of layers. For more complex architectures, you should use the <a href="http://keras.io/getting-started/functional-api-guide" target="_blank" rel="external">Keras functional API</a>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential </div><div class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense, Activation </div><div class="line"></div><div class="line">model = Sequential([ Dense(<span class="number">32</span>, input_dim=<span class="number">784</span>), </div><div class="line">    Activation(<span class="string">'relu'</span>), </div><div class="line">    Dense(<span class="number">10</span>),</div><div class="line">    Activation(<span class="string">'softmax'</span>), ])</div><div class="line"><span class="comment"># or</span></div><div class="line">model = Sequential() </div><div class="line">model.add(Dense(<span class="number">32</span>, input_dim=<span class="number">784</span>)) </div><div class="line">model.add(Activation(<span class="string">'relu'</span>))</div></pre></td></tr></table></figure>
<h3 id="specifying-the-input-shape"><a href="https://keras.io/getting-started/sequential-model-guide/" target="_blank" rel="external">Specifying the input shape</a></h3>
<h3 id="training">Training</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># generate dummy data</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line">data = np.random.random((<span class="number">1000</span>, <span class="number">784</span>))</div><div class="line">labels = np.random.randint(<span class="number">2</span>, size=(<span class="number">1000</span>, <span class="number">1</span>))</div><div class="line"></div><div class="line"><span class="comment"># train the model, iterating on the data in batches</span></div><div class="line"><span class="comment"># of 32 samples</span></div><div class="line">model.fit(data, labels, nb_epoch=<span class="number">10</span>, batch_size=<span class="number">32</span>)</div></pre></td></tr></table></figure>
<h3 id="examples">Examples</h3>
<h4 id="multilayer-perceptron-mlp-for-multi-class-softmax-classification">Multilayer Perceptron (MLP) for multi-class softmax classification:</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</div><div class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense, Dropout, Activation</div><div class="line"><span class="keyword">from</span> keras.optimizers <span class="keyword">import</span> SGD</div><div class="line"></div><div class="line">model = Sequential()</div><div class="line"><span class="comment"># Dense(64) is a fully-connected layer with 64 hidden units.</span></div><div class="line"><span class="comment"># in the first layer, you must specify the expected input data shape:</span></div><div class="line"><span class="comment"># here, 20-dimensional vectors.</span></div><div class="line">model.add(Dense(<span class="number">64</span>, input_dim=<span class="number">20</span>, init=<span class="string">'uniform'</span>))</div><div class="line">model.add(Activation(<span class="string">'tanh'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">64</span>, init=<span class="string">'uniform'</span>))</div><div class="line">model.add(Activation(<span class="string">'tanh'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">10</span>, init=<span class="string">'uniform'</span>))</div><div class="line">model.add(Activation(<span class="string">'softmax'</span>))</div><div class="line"></div><div class="line">sgd = SGD(lr=<span class="number">0.1</span>, decay=<span class="number">1e-6</span>, momentum=<span class="number">0.9</span>, nesterov=<span class="keyword">True</span>)</div><div class="line">model.compile(loss=<span class="string">'categorical_crossentropy'</span>,</div><div class="line">              optimizer=sgd,</div><div class="line">              metrics=[<span class="string">'accuracy'</span>])</div><div class="line"></div><div class="line">model.fit(X_train, y_train,</div><div class="line">          nb_epoch=<span class="number">20</span>,</div><div class="line">          batch_size=<span class="number">16</span>)</div><div class="line">score = model.evaluate(X_test, y_test, batch_size=<span class="number">16</span>)</div></pre></td></tr></table></figure>
<h4 id="alternative-implementation-of-a-similar-mlp">Alternative implementation of a similar MLP:</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">model = Sequential()</div><div class="line">model.add(Dense(<span class="number">64</span>, input_dim=<span class="number">20</span>, activation=<span class="string">'relu'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">64</span>, activation=<span class="string">'relu'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">10</span>, activation=<span class="string">'softmax'</span>))</div><div class="line"></div><div class="line">model.compile(loss=<span class="string">'categorical_crossentropy'</span>,</div><div class="line">              optimizer=<span class="string">'adadelta'</span>,</div><div class="line">              metrics=[<span class="string">'accuracy'</span>])</div></pre></td></tr></table></figure>
<h4 id="mlp-for-binary-classification">MLP for binary classification:</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">model = Sequential()</div><div class="line">model.add(Dense(<span class="number">64</span>, input_dim=<span class="number">20</span>, init=<span class="string">'uniform'</span>, activation=<span class="string">'relu'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">64</span>, activation=<span class="string">'relu'</span>))</div><div class="line">model.add(Dropout(<span class="number">0.5</span>))</div><div class="line">model.add(Dense(<span class="number">1</span>, activation=<span class="string">'sigmoid'</span>))</div><div class="line"></div><div class="line">model.compile(loss=<span class="string">'binary_crossentropy'</span>,</div><div class="line">              optimizer=<span class="string">'rmsprop'</span>,</div><div class="line">              metrics=[<span class="string">'accuracy'</span>])</div></pre></td></tr></table></figure>
<h2 id="convolutional-layers">Convolutional Layers</h2>
<p><strong>Convolution1D</strong> is usually applied to temporal data, like yours (assuming that you “samples” are in the temporal space, not the frequency space). In Keras, temporal data is understood as a tensor of shape<code>(nb_samples, steps, input_dim)</code>. The meaning of “sample” here is different from the one your are using, it simply means example / data point.</p>
<p>nb_samples = examples, steps = time dimension, input_dim = features at each time step.</p>
<h2 id="the-keras-functional-api">the Keras functional API</h2>
<h3 id="first-example-fully-connected-network">First example: fully connected network</h3>
<ul>
<li>A layer instance is callable (on a tensor), and it returns a tensor</li>
<li>Input tensor(s) and output tensor(s) can then be used to define a <code>Model</code></li>
<li>Such a model can be trained just like Keras <code>Sequential</code> models.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Input, Dense</div><div class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model</div><div class="line"></div><div class="line"><span class="comment"># this returns a tensor</span></div><div class="line">inputs = Input(shape=(<span class="number">784</span>,))</div><div class="line"></div><div class="line"><span class="comment"># a layer instance is callable on a tensor, and returns a tensor</span></div><div class="line">x = Dense(<span class="number">64</span>, activation=<span class="string">'relu'</span>)(inputs)</div><div class="line">x = Dense(<span class="number">64</span>, activation=<span class="string">'relu'</span>)(x)</div><div class="line">predictions = Dense(<span class="number">10</span>, activation=<span class="string">'softmax'</span>)(x)</div><div class="line"></div><div class="line"><span class="comment"># this creates a model that includes</span></div><div class="line"><span class="comment"># the Input layer and three Dense layers</span></div><div class="line">model = Model(input=inputs, output=predictions)</div><div class="line">model.compile(optimizer=<span class="string">'rmsprop'</span>,</div><div class="line">              loss=<span class="string">'categorical_crossentropy'</span>,</div><div class="line">              metrics=[<span class="string">'accuracy'</span>])</div><div class="line">model.fit(data, labels)  <span class="comment"># starts training</span></div></pre></td></tr></table></figure>
<h3 id="all-models-are-callable-just-like-layers">All models are callable, just like layers</h3>
<p>With the functional API, it is easy to re-use trained models: you can treat any model as if it were a layer, by calling it on a tensor. Note that by calling a model you aren’t just re-using the <em>architecture</em> of the model, you are also re-using its weights.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">x = Input(shape=(<span class="number">784</span>,)) <span class="comment"># this works, and returns the 10-way softmax we defined above.</span></div><div class="line">y = model(x)</div></pre></td></tr></table></figure>
<p>This can allow, for instance, to quickly create models that can process <em>sequences</em> of inputs. You could turn an image classification model into a video classification model, in just one line.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> TimeDistributed</div><div class="line"></div><div class="line"><span class="comment"># input tensor for sequences of 20 timesteps,</span></div><div class="line"><span class="comment"># each containing a 784-dimensional vector</span></div><div class="line">input_sequences = Input(shape=(<span class="number">20</span>, <span class="number">784</span>))</div><div class="line"></div><div class="line"><span class="comment"># this applies our previous model to every timestep in the input sequences.</span></div><div class="line"><span class="comment"># the output of the previous model was a 10-way softmax,</span></div><div class="line"><span class="comment"># so the output of the layer below will be a sequence of 20 vectors of size 10.</span></div><div class="line">processed_sequences = TimeDistributed(model)(input_sequences)</div></pre></td></tr></table></figure>
<h3 id="the-concept-of-layer-node">The concept of layer “node”</h3>
<p>Whenever you are calling a layer on some input, you are creating a new tensor (the output of the layer), and you are adding a “node” to the layer, linking the input tensor to the output tensor. When you are calling the same layer multiple times, that layer owns multiple nodes indexed as 0,1,2…</p>
<p>As long as a layer is only connected to one input, there is no confusion, and <code>.output</code> will return the one output of the layer. If the layer has multiple inputs: <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> lstm.get_output_at(<span class="number">0</span>) == encoded_a</div><div class="line"><span class="keyword">assert</span> lstm.get_output_at(<span class="number">1</span>) == encoded_b</div></pre></td></tr></table></figure></p>
<h2 id="about-keras-models">About Keras models</h2>
<p>There are two types of models available in Keras: <a href="https://keras.io/models/sequential" target="_blank" rel="external">the Sequential model</a> and <a href="https://keras.io/models/model" target="_blank" rel="external">the Model class used with functional API</a>.</p>
<p>These models have a number of methods in common:</p>
<ul>
<li><code>model.summary()</code>: prints a summary representation of your model.</li>
<li><code>model.get_config()</code>: returns a dictionary containing the configuration of the model. The model can be reinstantiated from its config via:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">config = model.get_config()</div><div class="line">model = Model.from_config(config)</div><div class="line"><span class="comment"># or, for Sequential:</span></div><div class="line">model = Sequential.from_config(config)</div></pre></td></tr></table></figure>
<ul>
<li><code>model.get_weights()</code>: returns a list of all weight tensors in the model, as Numpy arrays.</li>
<li><code>model.set_weights(weights)</code>: sets the values of the weights of the model, from a list of Numpy arrays. The arrays in the list should have the same shape as those returned by <code>get_weights()</code>.</li>
<li><code>model.to_json()</code>: returns a representation of the model as a JSON string. Note that the representation does not include the weights, only the architecture. You can reinstantiate the same model (with reinitialized weights) from the JSON string via:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> models <span class="keyword">import</span> model_from_json</div><div class="line"></div><div class="line">json_string = model.to_json()</div><div class="line">model = model_from_json(json_string)</div></pre></td></tr></table></figure>
<ul>
<li><code>model.to_yaml()</code>: returns a representation of the model as a YAML string. Note that the representation does not include the weights, only the architecture. You can reinstantiate the same model (with reinitialized weights) from the YAML string via:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">from models import model_from_yaml</div><div class="line"></div><div class="line">yaml_string = model.to_yaml()</div><div class="line">model = model_from_yaml(yaml_string)</div></pre></td></tr></table></figure>
<ul>
<li><code>model.save_weights(filepath)</code>: saves the weights of the model as a HDF5 file.</li>
<li><code>model.load_weights(filepath, by_name=False)</code>: loads the weights of the model from a HDF5 file (created by<code>save_weights</code>). By default, the architecture is expected to be unchanged. To load weights into a different architecture (with some layers in common), use <code>by_name=True</code> to load only those layers with the same name.</li>
</ul>
<h2 id="the-sequential-model-api"><a href="https://keras.io/models/sequential/" title="The Sequential model API" target="_blank" rel="external">The Sequential model API</a></h2>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:dad@sdz.red" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/sohero" target="_blank"><i class="fa fa-github"></i></a><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1261298720'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1261298720%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
</script></div><div class="footer">© 2017 <a href="/" rel="nofollow">Hero Memo</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><script>MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>